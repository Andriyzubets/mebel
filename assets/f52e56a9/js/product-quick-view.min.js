!function(a){"use strict";function b(b,e){this.element=b,this.settings=a.extend({},d,e),this._defaults=d,this._name=c,this._productIds=[],this._currentProductIndex=null,this._loading=!1,this.init()}var c="productQuickView",d={childs:".quick-view-button",selector:null,attributeName:"data-product-id",quickViewUrl:""};a.extend(b.prototype,{init:function(){var b=this;a(this.element).find(this.settings.childs).each(function(){a(this).attr(b.settings.attributeName)&&b._productIds.push(a(this).attr(b.settings.attributeName))}),this.popup=this.createNewPopup(),this.bindEvents()},createNewPopup:function(){var b=this,c=a('<div class="quick-view-popup blur-content"><div class="quick-view-content"></div></div>'),d=a('<span class="close"></a>');if(d.click(function(){b.close()}),c.append(d).appendTo("body"),this._productIds.length>1){var e=a('<div class="left-arrow"></div>'),f=a('<div class="right-arrow"></div>');e.click(function(){var a=null;a=b._currentProductIndex-1<0?b._productIds[b._productIds.length-1]:b._productIds[b._currentProductIndex-1],b.show(a)}),f.click(function(){var a=null;a=b._currentProductIndex+1==b._productIds.length?b._productIds[0]:b._productIds[b._currentProductIndex+1],b.show(a)}),c.append(e,f)}return c},bindEvents:function(){var b=this,c=this.popup;c.on("click",".quick-buy",function(){c.one("afterHide",function(){c.find(".fastorder-wrapper").blurdialog("show")}),c.blurdialog("hide")}),a(this.element).find(this.settings.childs+"["+this.settings.attributeName+"]").on("click",this.settings.selector,function(c){if(c.preventDefault(),c.stopPropagation(),b._loading)return!1;b._loading=!0,b.show(a(c.delegateTarget).attr(b.settings.attributeName))})},onContentLoad:function(){var b,c=this;c.popup.find(".features-list .youtube-video").each(function(){var d=a(".video__thumb img:first",this),e=c.popup.find(".big-image > div.active").attr("data-id");b=c.popup.find(".features-list .youtube-video").attr("id"),c.popup.find(".element-slider:first").each(function(){a('a[data-id="'+e+'"]',this).after('<a data-id="'+b+'" class="youtube-video-gallery-preview" rel="'+e+'"><img src="'+d.attr("src")+'" /><span class="play__icon3"></span></a>')})}),c.popup.blurdialog("show"),yii.analytics.triggerEvent("QUICKVIEW");var d=c.popup.find(".element-slider").children().size();c.popup.find(".element-slider").bxSlider({slideWidth:86,slideMargin:10,minSlides:4,maxSlides:4,moveSlides:1,pager:!1,nextText:"",prevText:"",controls:d>4,onSliderLoad:function(){var e=a("<div/>",{class:"left-shadow"}),f=a("<div/>",{class:"right-shadow"}),g=a("<i/>"),h=a("<i/>");d>3&&c.popup.find(".bx-controls-direction").prepend(e,f),c.popup.find(".bx-controls-direction .bx-prev").prepend(g),c.popup.find(".bx-controls-direction .bx-next").prepend(h),c.popup.find(".element-slider > a").click(function(d){if(a(this).hasClass("youtube-video-gallery-preview"))a('.big-image > div.picture[data-id="'+b+'"]').remove(),a(".big-image div.active",c.popup).stop().animate({opacity:0}),a(".features-list:first .youtube-video:first > div",c.popup).each(function(){if(a(this).hasClass("youtube-video-dialog")){var d=a(this).html();c.popup.find(".big-image > div.picture:first").after('<div class="picture" data-id="'+b+'"></div>'),a(".big-image div.active",c.popup).css("display","none").removeClass("active"),a('.big-image div[data-id="'+b+'"]',c.popup).css({display:"block",opacity:"0"}).animate({opacity:1},function(){a(this).addClass("active"),a(this).append(d),a("iframe",this).css({width:"472px",height:"217px"})})}});else{d.preventDefault();var e=a(this).data("id");a(".big-image div.active",c.popup).stop().animate({opacity:0},function(){a(this).css("display","none").removeClass("active"),a(".big-image div[data-id="+e+"]",c.popup).css({display:"block",opacity:"0"}).animate({opacity:1},function(){a(this).addClass("active")})})}})}}),"compareList"in yii&&c.popup.find(".addCompare").click(function(){yii.compareList.putProduct(a(this).attr("data-product-id"),!1),a(this).addClass("active")}),c.popup.find(".fastbuy").click(function(b){b.preventDefault(),a(this).parents(".head").find(".fast-order-form").slideDown("fast"),yii.analytics.triggerEvent("EC_QUICKORDER"),yii.analytics.triggerEvent("EC_QV_QUICKORDER")}),c.popup.find(".cancel-form").click(function(b){b.preventDefault(),a(this).parents(".head").find(".fast-order-form").slideUp("fast")}),c.popup.find(".fast-order-form form").on("beforeSubmit",function(b){var d=a(this),e=a("[name='QuickOrderForm[first_name]']",d),f=a("[name='QuickOrderForm[mobile]']",d);yii.analytics.triggerEvent("EC_QUICKORDER_FORM"),yii.analytics.triggerEvent("EC_QV_QUICKORDER_FORM"),a.post(d.attr("action"),d.serialize(),function(b){var g=c.popup,h=null;if(b.result){var i=[],j=[];(b.analytics_data.positions||[]).forEach(function(a){(a.products||[]).forEach(function(a){i.push({name:a.name,id:a.id,sku:a.id,price:parseInt(a.price),quantity:a.quantity,category:a.category,brand:"Диван.ру"}),j.push({productId:a.id,quantity:a.quantity,price:parseInt(a.price)})})}),window.dataLayer.push({event:"EC_CART_ORDERED",ecommerce:{purchase:{actionField:{id:b.analytics_data.order_info.id,revenue:parseInt(b.analytics_data.order_info.cost)},products:i}}}),directCrm("identify",{operation:"OneClickBuy",identificator:{provider:"mobilePhone",identity:f.length?f.val():""},data:{fullName:e.length?e.val():"",order:{webSiteId:b.analytics_data.order_info.id,price:parseInt(b.analytics_data.order_info.cost),items:j}}});Date.now;h=a('<div class="order-success"><div class="title">Это успех, друг!</div><div class="text">Ваш заказ успешно оформлен. О любом изменении статуса мы будем информировать вас по телефону. Спасибо!</div><div style="padding:18px 0 0;text-align:center"><a class="button white" href="#">Закрыть</a></div></div>')}else h=a('<div class="order-success"><div class="title">Ошибка...</div><div class="text">При оформлении заказа произошла ошибка. Попробуйте чуть позже.</div><div style="padding:18px 0 0;text-align:center"><a class="button white" href="#">Закрыть</a></div></div>');h&&d.fadeOut(500,function(){h.on("click",".button",function(a){a.preventDefault(),a.stopPropagation(),g.one("ct-blurdialog.afterHide",function(){h.off().remove(),d.show()}).blurdialog("hide")}),d.hide().after(h)}),d[0].reset(),d.data().yiiActiveForm.validated=!1},"json"),b.preventDefault()}).on("submit",function(a){a.preventDefault()}),c._loading=!1},show:function(b){var c=this;b=b;var d=a.inArray(b,this._productIds);-1!=d&&this.getProductHtml(b,function(a){c._currentProductIndex=d,c.popup.find(".quick-view-content").html(a),c.onContentLoad()})},close:function(){this.popup.blurdialog("hide")},getProductHtml:function(b,c){if(c)return this.settings.quickViewUrl?void a.get(this.settings.quickViewUrl,{productId:b},function(a){c(a)}):void c("")}}),a.fn[c]=function(d,e){return this.each(function(){var f=a.data(this,"plugin_"+c);f||a.data(this,"plugin_"+c,f=new b(this,d)),"string"==typeof d&&void 0!==f[d]&&f[d](e)})}}(jQuery,window,document);